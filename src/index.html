<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassWiz QR</title>
<style>
    #lang {
        width: 10%;
        height: 1.3rem;
    }

    #qrUrl {
        width: 88%;
        height: 1.3rem;
    }

    #qrResult {
        margin: 10px auto;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.2/dist/jsoneditor-minimalist.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.2/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
<div id="app">
    <label for="lang"></label>
    <select id="lang" name="lang">
        <option value="all" selected>All</option>
        <option value="zh">zh</option>
        <option value="en">en</option>
        <option value="vi">vi</option>
    </select>
    <label for="qrUrl"></label><input id="qrUrl" type="search"/>
    <div id="qrResult"></div>
</div>
<script>
  const lang = document.getElementById('lang');
  const qrResult = document.getElementById("qrResult");
  const qrUrl = document.getElementById("qrUrl");
  const options = {
    mode: 'view',
    name: 'cwqr',
    onEvent: async (node, event) => {
      if (event.type === 'click') {
        // console.log(node, event);
        let value
        if (node.value) {
          value = node.value;
        } else {
          value = editor.get();
          for (const key of node.path) {
            value = value[key];
          }
          value = JSON.stringify(value, null, 2);
        }
        await copyToClipboard(value);
        elementSelection(event.srcElement);
      }
    },
    mainMenuBar: false,
  };
  const editor = new JSONEditor(qrResult, options);

  lang.onchange = function () {
    parseQr(lang.value);
  }

  qrUrl.onchange = qrUrl.onsubmit = function () {
    location.hash = `#${qrUrl.value}`;
    parseQr(lang.value);
  }

  function parseOnHashChange() {
    qrUrl.value = location.hash.substring(1);
    parseQr(lang.value);
  }

  window.onhashchange = parseOnHashChange;

  window.onload = function () {
    lang.value = navigator.language.substring(0, 2);
    parseOnHashChange();
  }

  function parseQr(lang) {
    let result = {};
    if (qrUrl.value) {
      const qrResult = cwqr.parseUrl(qrUrl.value);
      extractLang(qrResult, lang);
      result = JSON.parse(JSON.stringify(qrResult));
    }
    editor.set(result);
    editor.expandAll();
  }

  function extractLang(resultObject, lang) {
    if (lang === 'all') {
      return resultObject;
    }
    for (const resKey in resultObject) {
      const resValue = resultObject[resKey];
      if (typeof resValue === 'object' && resValue[0]?.language) {
        for (const valueElement of resValue) {
          if (valueElement.language === lang) {
            resultObject[resKey] = valueElement.name;
            break;
          }
        }
      } else if (typeof resValue === 'object') {
        extractLang(resValue, lang);
      }
    }
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
    } catch (e) {
      console.log(e)
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed'; // 避免页面滚动
      textarea.style.opacity = '0'; // 隐藏 textarea
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
      } catch (err) {
        console.error('failed to copy');
        prompt('', text);
      }
      document.body.removeChild(textarea);
    }
  }

  function elementSelection(dom) {
    if (!dom || !(dom instanceof HTMLElement)) {
      console.error("请传入一个有效的 DOM 元素。");
      return;
    }

    const range = document.createRange(); // 创建一个 Range 对象
    range.selectNodeContents(dom);       // 设置 Range 的选中内容为 DOM 元素的文本内容
    const selection = window.getSelection(); // 获取全局 Selection 对象
    selection.removeAllRanges();         // 清除当前的选区
    selection.addRange(range);           // 添加新 Range 到选区
  }
</script>
</html>