<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<title>ClassWiz QR</title>
<style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    #app {
        margin: 0 auto;
        width: 100%;
    }

    @media (min-width: 768px) {
        #app {
            width: 91.666667%
        }
    }

    @media (min-width: 1024px) {
        #app {
            width: 83.333333%
        }
    }

    @media (min-width: 1280px) {
        #app {
            width: 66.666667%
        }
    }

    @media (min-width: 1536px) {
        #app {
            width: 58.333333%
        }
    }

    #MathJax_Message {
        display: none !important;
    }

    #lang {
        width: 10%;
        height: 1.3rem;
    }

    #qrUrl {
        width: 88%;
        height: 1.3rem;
    }

    details {
        margin: 10px auto;
    }

    details > :nth-child(2) {
        margin: 10px 15px;
    }

    summary {
        cursor: pointer;
    }

    .preview-table {
        border: thin solid #3883fa;
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
    }

    .preview-table td, .preview-table th {
        border: thin solid #3883fa;
        border-collapse: collapse;
        border-spacing: 0;
        padding: 5px 5px;
    }

    .transpose tr td:nth-child(1) {
        font-weight: bold;
    }

    .calc-result {
        margin: 10px auto;
    }

    #calc .title {
        font-weight: bold;
    }

    #calc .content {
        margin: 10px 15px;
    }

    #calc .right {
        text-align: right;
    }
</style>
<script async src="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.2/dist/jsoneditor-minimalist.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.2/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_CHTML"></script>
<div id="app">
    <label for="lang"></label>
    <select id="lang" name="lang">
        <option value="zh">zh</option>
        <option value="en" selected>en</option>
        <option value="vi">vi</option>
    </select>
    <label for="qrUrl"></label>
    <input id="qrUrl" type="search" placeholder="http://......"/>
    <details open>
        <summary data-i18n-tag="calc-title">Calculation</summary>
        <div id="calc"></div>
    </details>
    <details open>
        <summary data-i18n-tag="basic-title">Basic Info</summary>
        <div id="basic"></div>
    </details>
    <details open>
        <summary data-i18n-tag="settings-title">Settings</summary>
        <div id="settings"></div>
    </details>
    <details open>
        <summary data-i18n-tag="qr-parse-result-title">QR Parse Result</summary>
        <div id="qrResult"></div>
    </details>
</div>
<script>
  const lang = document.getElementById('lang');
  const qrUrl = document.getElementById("qrUrl");
  let editor;

  lang.onchange = function () {
    parseQr();
    localStorage.setItem('lang', lang.value);
    i18n();
  }

  qrUrl.onchange = qrUrl.onsubmit = function () {
    location.hash = `#${qrUrl.value}`;
    parseQr();
  }

  function parseOnHashChange() {
    qrUrl.value = location.hash.substring(1);
    parseQr();
  }

  window.onhashchange = parseOnHashChange;

  window.onload = function () {
    const options = {
      mode: 'view',
      name: 'cwqr',
      onEvent: async (node, event) => {
        if (event.type === 'click') {
          // console.log(node, event);
          let value
          if (node.value) {
            value = node.value;
          } else {
            value = editor.get();
            for (const key of node.path) {
              value = value[key];
            }
            value = JSON.stringify(value, null, 2);
          }
          await copyToClipboard(value);
          elementSelection(event.srcElement);
        }
      },
      mainMenuBar: false,
    };
    const qrResult = document.getElementById("qrResult");
    editor = new JSONEditor(qrResult, options);

    const userLang = localStorage.getItem('lang') || navigator.language.substring(0, 2);
    if (cwqr.availableLanguages.includes(userLang)) {
      lang.value = userLang;
      document.querySelector('html').setAttribute('lang', userLang);
    }
    i18n();
    parseOnHashChange();
  }

  function parseQr() {
    let parseResult = {}, setup, model, mode, expression, equation, result, matrix, vector;
    if (qrUrl.value) {
      const qrResult = cwqr.parseUrl(qrUrl.value, lang.value);
      ({ setup, model, mode, expression, equation, result, matrix, vector } = qrResult);
      parseResult = JSON.parse(JSON.stringify(qrResult));
    }
    settingsPreview(setup);
    basicPreview(model, mode);
    calculationPreview(expression, equation, result, matrix, vector);
    editor.set(parseResult);
    editor.expandAll();
  }

  function calculationPreview(expression, equation, result, matrix, vector) {
    const calc = document.getElementById('calc');
    calc.innerHTML = '';

    calc.innerHTML += expression ? `
<div class="calc-result" id="expression">
    <div class="title">${t('calc-expression')}</div>
    <div class="content">\\( ${expression} \\)</div>
</div>
` : '';

    calc.innerHTML += equation ? `
<div class="calc-result" id="equation">
    <div class="title">${t('calc-equation')}</div>
    <div class="content">\\( ${equation.latex} \\)</div>
    <div class="title">${t('calc-equation-coefficient')}</div>
    <table class="content preview-table"><tbody><tr>
    ${equation.element.map(row => `<td>\\( ${row.join(' \\)</td><td>\\( ')} \\)</td>`).join('</tr><tr>')}
    </tr></tbody></table>
</div>
` : '';

    calc.innerHTML += (result && result[0]) ? `
<div class="calc-result" id="result">
    <div class="title">${t('calc-result')}</div>
    <div class="content right">\\( ${result[0].latex} \\)</div>
    ${result.length > 1 ? `
    <table class="content preview-table"><thead>
  <tr>
    <th></th>
    <th>${t('calc-result-latex')}</th>
    <th>${t('calc-result-decimal')}</th>
  </tr></thead><tbody><tr>
    ${result?.map((r, i) => {
      if (i > 0) return `<td>${r.name}</td><td>\\( ${r.latex} \\)</td><td>${r.decimal}</td>`;
    }).join('</tr><tr>')}
    </tr></tbody></table>
    ` : ''
    }
</div>
` : '';

    const parseVectorMatrix = (vectorMatrix, id, title) => `
<div class="calc-result" id="${id}">
    <div class="title">${title}</div>
    ${vectorMatrix.map(vm => `
<div class="content">\\( \\mathrm\{${vm.name}\} = ${vm.latex} \\)</div>
<table class="content preview-table"><tbody><tr>
${vm.element.map(row => `<td>\\( ${row.join(' \\)</td><td>\\( ')} \\)</td>`).join('</tr><tr>')}
</tr></tbody></table>
`).join('')}
</div>
`;
    calc.innerHTML += matrix ? parseVectorMatrix(matrix, 'matrix', t('calc-matrix')) : '';
    calc.innerHTML += vector ? parseVectorMatrix(vector, 'vector', t('calc-vector')) : '';

    MathJax.Hub.Queue(["Typeset", MathJax.Hub, calc]);
  }

  function basicPreview(model, mode) {
    const basic = document.getElementById('basic');
    basic.innerHTML = '';
    if (!model || !mode) {
      return;
    }
    const table = document.createElement('table');
    table.classList.add('preview-table');
    table.innerHTML = `
<tbody class="transpose">
  <tr>
    <td>${t('mode-main')}</td>
    <td>${mode.mainName}</td>
  </tr>
  <tr>
    <td>${t('mode-sub')}</td>
    <td>${mode.subName || t('mode-na')}</td>
  </tr>
  <tr>
    <td>${t('model-key')}</td>
    <td>${model.name}</td>
  </tr>
  <tr>
    <td>${t('model-diag')}</td>
    <td>${model.type}-${model.id} Ver${model.version}</td>
  </tr>
  <tr>
    <td>${t('model-sn')}</td>
    <td>${model.serialNumber}</td>
  </tr>
</tbody>
`;
    basic.appendChild(table);
  }

  function settingsPreview(setup) {
    const settings = document.getElementById('settings');
    settings.innerHTML = '';
    if (!setup) {
      return;
    }
    const table = document.createElement('table');
    table.classList.add('preview-table');
    table.innerHTML = `<thead>
  <tr>
    <th>${t('settings-key')}</th>
    <th>${t('settings-value')}</th>
  </tr></thead>`;
    const tbody = document.createElement('tbody');
    for (const s of setup) {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${s.name}</td><td>${s.value}</td>`;
      tbody.appendChild(row);
    }
    table.appendChild(tbody);
    settings.appendChild(table);
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
    } catch (e) {
      console.log(e)
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
      } catch (err) {
        console.error('failed to copy');
        prompt('', text);
      }
      document.body.removeChild(textarea);
    }
  }

  function elementSelection(dom) {
    if (!dom || !(dom instanceof HTMLElement)) {
      return;
    }

    const range = document.createRange();
    range.selectNodeContents(dom);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function i18n() {
    document.querySelectorAll('[data-i18n-tag]').forEach(el => {
      const tag = el.getAttribute('data-i18n-tag');
      const text = t(tag);
      if (text) {
        el.innerText = text;
      }
    });
  }

  function t(tag, language) {
    if (!language) {
      language = lang.value;
    }
    const zh = {
      'calc-title': '计算数据',
      'calc-expression': '表达式',
      'calc-equation': '方程',
      'calc-equation-coefficient': '系数',
      'calc-result': '结果',
      'calc-result-latex': 'LaTeX',
      'calc-result-decimal': '数值',
      'calc-matrix': '矩阵预设',
      'calc-vector': '向量预设',
      'basic-title': '基本信息',
      'model-key': '型号',
      'model-diag': '自检信息',
      'model-sn': '序列号',
      'mode-main': '主模式',
      'mode-sub': '子模式',
      'mode-na': '/',
      'settings-title': '设置',
      'settings-key': '设置项',
      'settings-value': '设置值',
      'qr-parse-result-title': 'QR解析数据',
    };
    const en = {
      'calc-title': 'Calculation',
      'calc-expression': 'Expression',
      'calc-equation': 'Equation',
      'calc-equation-coefficient': 'Coefficients',
      'calc-result': 'Result',
      'calc-result-latex': 'LaTeX',
      'calc-result-decimal': 'Decimal',
      'calc-matrix': 'Matrix Presets',
      'calc-vector': 'Vector Presets',
      'basic-title': 'Basic Info',
      'model-key': 'Product Name',
      'model-diag': 'Diagnostic Info',
      'model-sn': 'Serial Number',
      'mode-main': 'Main Mode',
      'mode-sub': 'Sub Mode',
      'mode-na': '/',
      'settings-title': 'Settings',
      'settings-key': 'Settings',
      'settings-value': 'Settings Value',
      'qr-parse-result-title': 'QR Parse Result',
    };
    return (({ 'zh': zh, 'en': en, }[language] || en)[tag]) || tag;
  }
</script>
</html>